# ~/.config/tmux/tmux.conf
# ----------------------------------------------------

# === Plugin Manager (TPM) ==================================================
set-environment -g TMUX_PLUGIN_MANAGER_PATH "$HOME/.local/share/tmux/plugins"

if-shell "[ ! -d '#{TMUX_PLUGIN_MANAGER_PATH}/tpm' ]" {
    run "mkdir -p '#{TMUX_PLUGIN_MANAGER_PATH}'"
    run "git clone https://github.com/tmux-plugins/tpm '#{TMUX_PLUGIN_MANAGER_PATH}/tpm'"
    run "'#{TMUX_PLUGIN_MANAGER_PATH}/tpm/bin/install_plugins'"
}

# === General Settings =======================================================
set -g default-terminal "screen-256color"
set -g mouse on
set -s escape-time 10
set -sg repeat-time 600
set -s focus-events on
set -q -g status-utf8 on
setw -q -g utf8 on
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g status-interval 10

# Prefix
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# === Plugins ================================================================
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'angelaltuve/tmux-colours-superhero'
set -g @plugin 'tmux-plugins/tpm'

# === Initialize TPM =========================================================
run '#{TMUX_PLUGIN_MANAGER_PATH}/tpm/tpm'

# === Key Tables =============================================================
set-window-option -g mode-keys vi

# Copy mode (vi style)
bind Enter copy-mode
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi C-v send -X rectangle-toggle
bind -T copy-mode-vi y send -X copy-pipe-and-cancel "xclip -in -selection clipboard"
bind -T copy-mode-vi Escape send -X cancel
bind -T copy-mode-vi H send -X start-of-line
bind -T copy-mode-vi L send -X end-of-line
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "xclip -in -selection clipboard"

# === Windows & Panes ========================================================
bind c new-window -c "#{pane_current_path}"
bind C-c new-session

# Splits (keep current path)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# Vim-style pane navigation (repeatable)
bind -r h select-pane -L
bind -r j select-pane -D
bind -r k select-pane -U
bind -r l select-pane -R

# Resize (repeatable)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Window navigation
unbind n
unbind p
bind -r C-h previous-window
bind -r C-l next-window
bind Tab last-window

# Swap windows
bind -r "<" swap-window -d -t -1
bind -r ">" swap-window -d -t +1

# === Miscellaneous ==========================================================
bind r source-file ~/.config/tmux/tmux.conf \; display "Config reloaded!"
bind e new-window -n "tmux.conf" "nvim ~/.config/tmux/tmux.conf"

# Clear screen + history
bind -n C-l send-keys C-l \; run 'sleep 0.05' \; clear-history

# URL opener
bind u capture-pane -J \; save-buffer /tmp/tmux-buffer \; new-window -n "urls" "urlview /tmp/tmux-buffer || true"

# Session switcher popup (fzf)
bind C-j display-popup -E "tmux list-sessions -F '#{session_name}' | grep -v \"^$(tmux display-message -p '#S')\$\" | fzf --reverse | xargs -I {} tmux switch-client -t {}"

# Daily Note
bind C-a run-shell "tmux neww ~/.local/bin/tmux/dailyNote.sh"

# Open Personal Notes
bind C-p run-shell "tmux neww ~/.local/bin/tmux/personal_notes"

# Open github url
bind C-g run-shell "~/.local/bin/tmux/open-github.sh"

# Quick popups
bind C-f display-popup -w90% -h90% -E "ncmpcpp"
bind C-r display-popup -w90% -h90% -E "lfrun"
bind C-t display-popup -w80% -h80% -E "zsh"

# Dotfiles menu
bind d display-menu -T " Dotfiles " -x R -y W \
    "Edit .zshrc"    z "display-popup -E 'nvim ~/.config/zsh/.zshrc'" \
    "Edit tmux.conf" t "display-popup -E 'nvim ~/.config/tmux/tmux.conf'" \
    "" "" \
    "Close"          q ""
