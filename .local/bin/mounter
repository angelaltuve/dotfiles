#!/bin/bash

set -euo pipefail
IFS=$'\n'

TERMINAL="${TERMINAL:-st}"

escape() {
  echo "$@" | iconv -cf UTF-8 -t ASCII//TRANSLIT | tr -d '[:punct:]' | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | sed "s/-\+/-/g;s/^-//;s/-$//"
}

# ğŸ“± Android phones (MTP)
phones_raw=$(simple-mtpfs -l 2>/dev/null || true)
phones=""
if [ -n "$phones_raw" ]; then
  phones="$(echo "$phones_raw" | sed 's/^/ğŸ“±/')"
  mountedphones="$(grep simple-mtpfs /etc/mtab || true)"
  if [ -n "$mountedphones" ]; then
    phones="$(for phone in $phones; do
      escphone="$(escape "$phone")"
      echo "$mountedphones" | grep -q "$escphone" || echo "$phone"
    done)"
  fi
fi

# ğŸ“‹ Disks & Partitions
lsblkout="$(lsblk -nrpo 'UUID,NAME,TYPE,SIZE,LABEL,MOUNTPOINT,FSTYPE')"

# ğŸ” LUKS Devices
luks_devices=$(sudo -A blkid -t TYPE=crypto_LUKS -o device || true)

# Get opened LUKS UUIDs
opened=$(find /dev/mapper -type l -lname '/dev/dm-*' -printf '%f\n' | sed 's/^.*-//' || true)

# Collect unopened LUKS# Collect unopened LUKS\ununopened_luks=""
for dev in $luks_devices; do
  uuid=$(sudo -A blkid -s UUID -o value "$dev" | tr -d '-')
  echo "$opened" | grep -q "$uuid" && continue
  info=$(lsblk -nrpo 'NAME,TYPE,SIZE,LABEL,MOUNTPOINT' "$dev" | head -n1)
  unopened_luks+="ğŸ”’ $info"$'\n'
done

# ğŸ“‹ Unmounted partitions
normal_parts="$(echo "$lsblkout" | grep 'part\|rom\|crypt' | sed "s/^/ğŸ“‹ /" | sed "s/ /:/g" | awk -F':' '$7==""{printf "%s%s (%s) %s\n",$1,$3,$5,$6}')"

# ğŸ“‹ Combine all
all_mountables="$(printf "%s\n%s\n%s\n" "$phones" "$unopened_luks" "$normal_parts" | sed '/^$/d')"
[ -z "$all_mountables" ] && notify-send "No devices found" && exit 0

# â“ User selects device
chosen="$(echo "$all_mountables" | dmenu -i -p "Mount which device?")"
[ -z "$chosen" ] && exit 1

# Ask mount point
# get_mount_point() {
#   mp="$(find /mnt /media /mount /home -maxdepth 1 -type d -print -quit 2>/dev/null | dmenu -i -p "Mount to where?")"
#   if [ -z "$mp" ] || [ ! -d "$mp" ]; then
#     notify-send "âŒ Invalid mount point" "Directory does not exist: $mp"
#     exit 1
#   fi
#   echo "$mp"
# }

get_mount_point(){
	mp="$(printf "/mnt\n/\n/media\n/mount\n/home" | dmenu -i -p "Mount this drive where?")"
	test -n "$mp"
	if [ ! -d "$mp" ]; then
		mkdiryn=$(printf "No\\nYes" | dmenu -i -p "$mp does not exist. Create it?")
		[ "$mkdiryn" = "Yes" ] && (mkdir -p "$mp" || sudo -A mkdir -p "$mp")
	fi
}

# Mount attempt
try_fstab_mount() {
  if sudo -A mount "$1"; then
    notify-send "ğŸ“‹ Mounted" "$1 mounted."
    exit 0
  fi
  return 1
}

# ğŸ§  Logic by type
case "$chosen" in
ğŸ“‹*)
  dev=$(echo "$chosen" | awk '{print $2}')
  if ! try_fstab_mount "$dev"; then
    get_mount_point
    fstype=$(sudo -A blkid -s TYPE -o value "$dev")
    case "$fstype" in
    vfat) sudo -A mount -t vfat "$dev" "$mp" -o rw,umask=0000 ;;
    btrfs) sudo -A mount "$dev" "$mp" ;;
    *) sudo -A mount "$dev" "$mp" -o uid="$(id -u)",gid="$(id -g)" ;;
    esac
    notify-send "ğŸ“‹ Drive Mounted" "$dev mounted to $mp"
  fi
  ;;

ğŸ”’*)
  dev=$(echo "$chosen" | awk '{print $2}')
  name="usb$(date +%s)"

  "$TERMINAL" -n floatterm -g 60x10 -e bash -c "sudo cryptsetup open '$dev' '$name'; echo 'Press Enter to close...'; read -r"

  mapper="/dev/mapper/$name"
  if [ ! -b "$mapper" ]; then
    notify-send "âŒ Decryption failed" "Revisa la terminal para detalles."
    exit 1
  fi

  if ! try_fstab_mount "$mapper"; then
    get_mount_point

    fstype="$(sudo -A blkid -s TYPE -o value "$mapper")"
    case "$fstype" in
    vfat) sudo -A mount -t vfat "$mapper" "$mp" -o rw,umask=0000 ;;
    btrfs) sudo -A mount "$mapper" "$mp" ;;
    *) sudo -A mount -o uid="$(id -u),gid=$(id -g)" "$mapper" "$mp" ;;
    esac

    notify-send "ğŸ”“ Decrypted and Mounted" "$dev â†’ $mp"
  fi
  ;;

ğŸ“±*)
  notify-send "ğŸ“± MTP Device" "Allow file access on your phone."
  get_mount_point
  dev_id=$(echo "$chosen" | cut -d: -f1 | tr -cd '0-9')
  escname=$(escape "$chosen")
  sudo -A simple-mtpfs -o allow_other -o fsname="mtpfs-$escname" --device "$dev_id" "$mp"
  if mountpoint -q "$mp"; then
    notify-send "ğŸ“± Android Mounted" "Mounted to $mp"
  else
    notify-send "âŒ MTP Mount Failed" "Check USB access or permissions."
  fi
  ;;
esac
