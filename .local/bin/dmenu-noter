#!/usr/bin/env bash

EDITOR=${EDITOR:-nvim}
VIEW=${VIEW:-zathura}
TERMINAL=${TERMINAL:-xterm}
MENU="dmenu -c -l 10 -p"

# <------- Directories ------>#
book_library="$HOME/Documents/books"
note_library="$HOME/docs/personal"
article_library="$HOME/Downloads/articles"
diary="$HOME/docs/personal/diary.gpg"
todo_list="$HOME/docs/personal/todo.txt"

# Sync
storage=storage/shared/Documents/markor
server=rdata

# <<------ Options ------>> #
declare -A actions
actions["ğŸ“‘ Create Note"]=$note_library
actions["ğŸ”– View Notes"]=$note_library
actions["ğŸ“š Books"]=$book_library
actions["ğŸ“œ Articles"]=$article_library
actions["ğŸ”„ Sync"]=$note_library
actions["ğŸ“” Diary"]=$diary
actions["ğŸ“ Todo list"]=$todo_list
actions["ğŸ” Search"]="$note_library"
actions["ğŸ–¨ï¸ Print"]="$note_library"

# <<------ main ------->>
create_document() {
  local dir type name file
  dir="$1"
  type=$(echo -e "Basic\nLaTeX\nBeamer\nRmark" | $MENU "What kind of note?")
  [[ -z "$type" ]] && return

  case "$type" in
  Basic)
    template="simplenote.md"
    ext="md"
    msg="Basic Document Created!"
    ;;
  LaTeX)
    template="latex.tex"
    ext="tex"
    msg="LaTeX Document Created!"
    ;;
  Beamer)
    template="presentation.tex"
    ext="tex"
    msg="Beamer Presentation Created!"
    ;;
  Rmark)
    template="rmarkdown.rmd"
    ext="rmd"
    msg="R Markdown Document Created!"
    ;;
  *) return 1 ;;
  esac

  name=$(echo "" | $MENU "Enter a name for the note:")
  [[ -z "$name" ]] && {
    return
  }

  file="$dir/$name.$ext"
  if [[ -f "$file" ]] && ! (echo -e "Yes\nNo" | $MENU "Note already exists. Overwrite?" | grep -q "^Yes$"); then
    return
  fi

  notify-send --icon="document-new" "$msg"
  cp "$dir/templates/$template" "$file"
  setsid -f "$TERMINAL" -e "$EDITOR" "$file" >/dev/null 2>&1
}

edit_todo() {
  setsid -f "$TERMINAL" -e "$EDITOR" "$todo_list" >/dev/null 2>&1
}

# <<------ Search -------->> #
search_notes() {
  local choice query results file line full_path

  choice=$(printf "Keyword\nTags\nAuthor" | $MENU "Search by:")
  [[ -z "$choice" ]] && return
  query=$(printf "" | $MENU "$choice to search:")
  [[ -z "$query" ]] && return

  case "$choice" in
  Keyword)
    mapfile -t results < <(rg -i -n --no-heading -- "$query" "$note_library")
    ;;
  Tags)
    mapfile -t results < <(grep -l -i "tags:.*$query" "$note_library"/*.md 2>/dev/null)
    ;;
  Author)
    mapfile -t results < <(rg -l -i "^author:.*$query" "$note_library"/*.md 2>/dev/null)
    ;;
  *) return ;;
  esac

  [[ ${#results[@]} -eq 0 ]] && {
    notify-send "ğŸ” Search" "No results for '$query'"
    return
  }

  if [[ "$choice" == "Keyword" ]]; then
    mapfile -t files < <(printf '%s\n' "${results[@]}" | cut -d: -f1 | xargs -n1 basename | sort -u)
  else
    mapfile -t files < <(printf '%s\n' "${results[@]}" | xargs -n1 basename | sort -u)
  fi

  file=$(printf '%s\n' "${files[@]}" | nl | tr "\t" " " | $MENU "Results (${#results[@]} occurrences):" | awk '{print $2}')
  [[ -z "$file" ]] && return

  full_path=$(find "$note_library" -type f -name "$file" -print -quit)
  [[ -z "$full_path" ]] && return

  if [[ "$choice" == "Keyword" ]]; then
    line=$(printf '%s\n' "${results[@]}" | grep -m1 "/$file:" | cut -d: -f2)
  else
    line=1
  fi

  setsid -f "$TERMINAL" -e "$EDITOR" "+$line" "$full_path" >/dev/null 2>&1
}

search_todo() {
  local choice results selection line

  choice=$(printf "%s\n" "Priority" "Tags" "Last Month" | $MENU "Search by:")
  [[ -z "$choice" ]] && return 0

  case "$choice" in
  Priority)
    mapfile -t results < <(
      rg -n '\([A-Z]\)' -- "$todo_list"
    )
    ;;
  Tags)
    mapfile -t results < <(
      rg -n '(?:^|\s)\+\S+' -- "$todo_list"
    )
    ;;
  "Last Month")
    mapfile -t results < <(
      rg -n "$(date -d 'last month' '+%Y-%m')" -- "$todo_list"
    )
    ;;
  *)
    return 0
    ;;
  esac

  [[ ${#results[@]} -eq 0 ]] && {
    notify-send "TODO Search" "No results found."
    return
  }

  selection=$(
    printf '%s\n' "${results[@]}" |
      awk -F: '{print $2 $3}' |
      sort -u | nl | tr "\t" " " |
      $MENU "Results (${#results[@]} matches):" | awk '{print $2}'
  )

  [[ -z "$selection" ]] && return 0

  line=$(printf '%s\n' "${results[@]}" | grep -F ":$selection" | head -n1 | cut -d: -f1)

  setsid -f "$TERMINAL" -e "$EDITOR" "+$line" "$todo_list" >/dev/null 2>&1
}

search() {
  local where
  where=$(printf "Notes\nTodo" | $MENU "Search in:")
  case "$where" in
  Notes)
    search_notes
    ;;
  Todo)
    search_todo
    ;;
  *) return ;;
  esac
}

# <<------ Misc ------>> #

select_and_open() {
  local dir exts cmd file full
  dir="$1"
  exts="$2"
  cmd="$3"

  #shellcheck disable=SC2086
  file=$(find "$dir" -type f \( $exts \) -printf "%f\n" | $MENU "Select:")
  [[ -z "$file" ]] && return

  full=$(find "$dir" -type f -name "$file" -print -quit)
  #shellcheck disable=SC2086
  [[ -f "$full" ]] && setsid -f $cmd "$full" >/dev/null 2>&1
}

sync_notes() {
  if ping -c1 -W5 "$server" >/dev/null 2>&1; then
    rsync -rtuP "$note_library"/ "$server:$storage" || return
    rsync -rtuP "$server:$storage"/ "$note_library" || return
    notify-send --icon="folder-sync" "The notes have been synchronized"
  else
    notify-send --icon="script-error" "server unavailable"
  fi
}

edit_diary() {
  local temp choice

  temp=$(mktemp -t diary-XXXXXX) || {
    echo "Failed to create temp file"
    return 1
  }

  choice=$(gpg --list-secret-keys --keyid-format=long |
    awk '/uid/ {print $NF}' |
    sort |
    $MENU "Select Key:")
  [[ -z "$choice" ]] && {
    echo "No key selected"
    rm -f "$temp"
    return 1
  }

  if [[ -f "$diary" ]]; then
    gpg -q --yes --decrypt -o "$temp" "$diary" || {
      echo "Failed to decrypt diary"
      rm -f "$temp"
      return 1
    }
  fi

  "$TERMINAL" -e "$EDITOR" \
    -c "set noswapfile noundofile nobackup nowritebackup noshelltemp shada= history=0 nomodeline secure" \
    -c "setlocal tw=80 colorcolumn=80 fo=awqtc comments+=nb:> spell spelllang=es,en_us tabstop=2 shiftwidth=2 expandtab" \
    -c "setf markdown" \
    -c "normal! Go## $(date '+%F %H:%M')" \
    -c "normal! G2o" \
    -c "normal! D" \
    -c "startinsert" \
    "$temp"

  if ! gpg -q --yes --encrypt --recipient "$choice" -o "$diary" "$temp"; then
    echo "Failed to encrypt diary"
    rm -f "$temp"
    return 1
  fi

  rm -f "$temp"
}

md_to_pdf() {
  local file full pdf
  file=$(find "$note_library" -name "*.md" -printf "%f\n" | $MENU "Select note to convert:")
  [[ -z "$file" ]] && return
  full=$(find "$note_library" -name "$file" -print -quit)
  pdf="${full%.md}.pdf"
  pandoc -t ms --highlight-style="kate" -s -o "$pdf" "$full"
  notify-send "Converted to PDF: $pdf"
  setsid -f "$VIEW" "$pdf"
}

# <<------ Main ------>> #

main() {
  local selected
  selected=$(printf '%s\n' "${!actions[@]}" | $MENU "ğŸ“‚ Choose an action:")
  [[ -z "$selected" ]] && exit 0

  local target="${actions[$selected]}"

  case "$selected" in
  "ğŸ“‘ Create Note") create_document "$target" ;;
  "ğŸ”– View Notes") select_and_open "$target" "-name *.md" "$TERMINAL -e $EDITOR" ;;
  "ğŸ“š Books" | "ğŸ“œ Articles")
    select_and_open "$target" "-name *.epub -o -name *.mobi -o -name *.pdf" "$VIEW"
    ;;
  "ğŸ”„ Sync") sync_notes ;;
  "ğŸ“” Diary") edit_diary ;;
  "ğŸ“ Todo list") edit_todo ;;
  "ğŸ” Search") search ;;
  "ğŸ–¨ï¸ Print") md_to_pdf ;;
  *) return ;;
  esac
}

main
