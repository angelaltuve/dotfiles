#!/usr/bin/env bash
#
# Battery module for dwmblocks
# - Shows battery icon and percentage using acpi
# - Warns if low battery
# - Scroll to adjust brightness
# - Right click shows battery details via notification

case "$BUTTON" in
3) # right click: show battery details
  info=$(acpi -b 2>/dev/null)
  if [ -n "$info" ]; then
    notify-send -u normal -i battery "$info"
  else
    notify-send -u critical -i battery "No battery found"
  fi
  ;;
4) # scroll up: increase brightness
  xbacklight -inc 10 2>/dev/null
  ;;
5) # scroll down: decrease brightness
  xbacklight -dec 10 2>/dev/null
  ;;
6) # shift+click: edit this script
  setsid -f "${TERMINAL:-xterm}" -e "${EDITOR:-vi}" "$0" 2>/dev/null
  ;;
esac

# Get battery info from acpi (first battery)
battery_info=$(acpi -b 2>/dev/null | head -1)
if [ -z "$battery_info" ]; then
  printf " No battery"
  exit 0
fi

# Extract status and percentage
status=$(echo "$battery_info" | awk -F'[:,]' '{print $2}' | xargs)
percent=$(echo "$battery_info" | grep -o '[0-9]\+%' | tr -d '%')

# Default values
[ -z "$percent" ] && percent=0

# Choose icon based on status and percentage
case "$status" in
Discharging)
  if [ "$percent" -ge 90 ]; then
    icon=" "
  elif [ "$percent" -ge 70 ]; then
    icon=" "
  elif [ "$percent" -ge 40 ]; then
    icon=" "
  elif [ "$percent" -ge 20 ]; then
    icon=" "
  else
    icon=" "
  fi
  ;;
Charging | Full)
  icon=" "
  ;;
*)
  icon=" "
  ;;
esac

# Warning for low battery while discharging
warn=""
if [ "$status" = "Discharging" ] && [ "$percent" -le 20 ]; then
  warn=" "
fi

# Output
printf "%s%s%s%%\n" "$icon" "$warn" "$percent"
