#!/usr/bin/env bash
#
# Mail status script for dwmblocks
# - Shows number of unread emails
# - Shows "" icon when syncing mail
# - Left click  : open neomutt
# - Middle click: sync mail
# - Right click : show help
# - Extra button: edit this script

MAIL_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/mail"
MAIL_ICON=""
SYNC_ICON=""

case "$BUTTON" in
1)
  setsid -w -f "$TERMINAL" -e neomutt
  kill -46 "$(pidof dwmblocks)"
  ;;
2)
  setsid -f mailsync
  ;;
3)
  notify-send "$MAIL_ICON Mail module" "\
- Shows unread mail count
- Shows $SYNC_ICON if syncing
- Left click: open neomutt
- Middle click: sync mail"
  ;;
6)
  setsid -f "$TERMINAL" -e "$EDITOR" "$0"
  ;;
esac

icon=""
if pidof -sx mbsync >/dev/null 2>&1; then
  icon="$SYNC_ICON"
fi

unread=0
if [ -d "$MAIL_DIR" ]; then
    unread=$(find "$MAIL_DIR" -path '*/[Ii][Nn][Bb][Oo][Xx]/new/*' -type f 2>/dev/null | wc -l)
    unread=$((unread))
fi

if [ "$unread" -gt 0 ] || [ -n "$icon" ]; then
    printf "%s %d%s" "$MAIL_ICON" "$unread" "$icon"
fi
